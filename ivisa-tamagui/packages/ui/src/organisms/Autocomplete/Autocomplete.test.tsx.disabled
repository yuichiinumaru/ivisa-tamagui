import { render, screen } from '../../../vitest.setup';
import { vi, describe, it, expect } from 'vitest';
import { Autocomplete, AutocompleteOption } from './Autocomplete';

const options: AutocompleteOption[] = [
  { label: 'React', value: 'react' },
  { label: 'Vue', value: 'vue' },
  { label: 'Svelte', value: 'svelte' },
];

describe('Autocomplete', () => {
  it('renders with placeholder', () => {
    render(<Autocomplete options={options} placeholder="Select a framework" />);
    // Use regex to be flexible or exact string
    expect(screen.getByText('Select a framework')).toBeInTheDocument();
  });

  it('opens the popover on click', async () => {
    const { user } = render(<Autocomplete options={options} />);
    const trigger = screen.getByRole('combobox');
    await user.click(trigger);
    expect(screen.getByPlaceholderText('Search...')).toBeInTheDocument();
  });

  it('filters options based on search input', async () => {
    const { user } = render(<Autocomplete options={options} />);
    const trigger = screen.getByRole('combobox');
    await user.click(trigger);

    const searchInput = screen.getByPlaceholderText('Search...');
    await user.type(searchInput, 'React');

    expect(screen.getByText('React')).toBeInTheDocument();
    expect(screen.queryByText('Vue')).not.toBeInTheDocument();
    expect(screen.queryByText('Svelte')).not.toBeInTheDocument();
  });

  it('calls onValueChange with the selected option', async () => {
    const onValueChange = vi.fn();
    const { user } = render(<Autocomplete options={options} onValueChange={onValueChange} />);
    const trigger = screen.getByRole('combobox');
    await user.click(trigger);

    const option = screen.getByText('Vue');
    await user.click(option);

    expect(onValueChange).toHaveBeenCalledWith({ label: 'Vue', value: 'vue' });
  });

  it('displays the selected value', () => {
    const selectedOption = { label: 'Svelte', value: 'svelte' };
    render(<Autocomplete options={options} value={selectedOption} />);
    expect(screen.getByText('Svelte')).toBeInTheDocument();
  });

  it('shows empty message when no options match', async () => {
    const { user } = render(<Autocomplete options={options} emptyMessage="No frameworks found" />);
    const trigger = screen.getByRole('combobox');
    await user.click(trigger);

    const searchInput = screen.getByPlaceholderText('Search...');
    await user.type(searchInput, 'Angular');

    expect(screen.getByText('No frameworks found')).toBeInTheDocument();
  });
});
