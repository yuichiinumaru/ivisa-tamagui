# Logging Strategy – Shadcn → Tamagui Migration

## 1. Objectives
- Provide traceability for every migration activity using consistent log naming (`log-<area>-aaaammdd hhmmss.log`).
- Support debugging across web and native builds during Tamagui integration.
- Ensure logs inform testing (TDD) and spec validation (SDD) while aligning with domain terminology (DDD).

## 2. Log Taxonomy
| Area | Description | Responsible Phase | Example Filename |
| --- | --- | --- | --- |
| config | Tamagui token setup, provider wiring | Phase 1 | `log-config-20251106 130000.log` |
| primitive | Core primitives (Button, Text) | Phase 2 | `log-primitive-button-20251110 091500.log` |
| form | Inputs, Select, Checkbox, Radio | Phase 3 | `log-form-select-20251115 103000.log` |
| overlay | Dialog, Popover, Tooltip | Phase 3 | `log-overlay-dialog-20251118 141200.log` |
| integration | App flows, performance audits | Phase 4 | `log-integration-chatflow-20251122 170500.log` |
| handoff | Documentation, KT sessions | Phase 5 | `log-handoff-20251201 110000.log` |

## 3. Storage & Retention
- **Primary Root:** `MIGRATION_LOG_ROOT` env var (defaults to `${project_root}/logs/migration/shadcn-tamagui`).
- **Structure:** `<area>/<component>/log-<area>-aaaammdd hhmmss.log`
  - Example: `/logs/migration/shadcn-tamagui/form/select/log-form-select-20251115 103000.log`
- **Rotation:** One file per execution context (script run, test suite, component demo). New timestamp → new file.
- **Retention:**
  1. Keep raw files locally for 30 days.
  2. Weekly cron bundles logs into `migration-output/log-archives/<YYYY-MM-DD>.tar.gz`.
  3. Upload archives to long-term storage (S3 bucket `vivi-agent-logs`) monthly; expire after 180 days.
- **Access Control:** Read access for engineering, write access restricted to migration tooling/CI. Cloud bucket enforces IAM role `vivi-migration-writer`.

## 4. Logging Guidelines
1. Always obtain logger via `get_logger(area, verbose=bool)` from `scripts/logger_utils` to guarantee UTC timestamps.
2. Include structured extras: `{"environment": "web"|"native", "test_id": "Button.spec.tsx#renders"}`.
3. Capture portal mounting status, focus traps, token resolutions, accessibility audits, and token fallback usage.
4. On failure, log actionable context: component props (PII scrubbed), state snapshot, reproduction steps.
5. Reference spec checklist IDs (e.g., `spec:button:focus-ring`) so QA can trace expectations.
6. CI pipelines upload logs as artifacts tagged by phase/area and attach to GitHub Actions run summary.

## 5. Tooling & Automation
- **Runtime Logging:**
  - `scripts/logger_utils.get_logger` for Python tooling.
  - Tamagui app uses a lightweight wrapper emitting to browser console and POST `/api/migration-logs` when `MIGRATION_LOG_ROOT_REMOTE` set.
- **CI Integration:**
  - `conda run -n 12 python scripts/export_logs.py --dest migration-output/log-archives` bundles logs per phase.
  - GitHub Actions step uploads archive + most recent log to run artifacts.
- **Monitoring:**
  - Optional ELK shipping: run `scripts/forward_logs.py --since 24h` to push to Logstash.
  - PagerDuty integration triggers on error-level entries tagged `severity=critical`.

## 6. Review & Maintenance
- **Cadence:** Review logs weekly during standups; summarize noteworthy findings in `docs/04-changelog.md`.
- **Drift Watch:** Ensure duplicated infrastructure copies (e.g., `tamagui-components-final/infrastructure/logger_utils.py`) stay in sync with canonical module.
- **Evolution:** Update this strategy when new component categories or environments emerge.
- **Backlog:** Capture improvement ideas in `docs/05-ideas.md` with reference to log area.

## 7. Centralized Telemetry Schema
- **Record layout (JSON per line):**
  ```json
  {
    "timestamp": "2025-11-14T21:10:00Z",
    "area": "form",
    "component": "select",
    "phase": "P0",
    "environment": "web",
    "platform": "chrome",
    "spec_id": "spec:select:portal",
    "test_id": "Select.spec.tsx#keyboard-nav",
    "severity": "INFO",
    "message": "portal mounted",
    "duration_ms": 42,
    "token_usage": {"prompt": 0, "completion": 0},
    "extras": {"run_id": "2025-11-14-select-regression", "ci_job": "vitest-web", "git_sha": "abc123"}
  }
  ```
- **Mandatory fields:** `timestamp`, `area`, `component`, `severity`, `message`, `run_id`, `environment`.
- **Optional fields:** `phase`, `spec_id`, `test_id`, `duration_ms`, `token_usage`, `extras.*`.
- **Correlation IDs:**
  - `run_id` = `<phase>-<component>-<yyyymmdd>-<seq>` generated by scripts.
  - `ci_job` ties to GitHub Actions run; local development uses `dev-<initials>`.
- **Severity mapping:** DEBUG (dev diagnostics) → INFO (expected milestones) → WARN (non-blocking drift) → ERROR (test/spec failure) → CRITICAL (production-impacting regression). PagerDuty triggers on CRITICAL.

## 8. Metrics & Reporting Workflow
- **Daily aggregation:** `conda run -n 12 python scripts/summarize_logs.py --since 24h --schema centralized` outputs CSV + Markdown snippet for standup.
- **Dashboard:** Data forwarded to ELK indexes `vivi-shadcn-*`; Kibana board tracks:
  1. Error count by component/phase.
  2. Portal mount duration p95.
  3. Agent token usage vs rate-limit budget (`token_usage` field).
  4. TDD coverage status (joins `test_id` with Vitest reports).
- **Alerts:**
  - WARN spike (>5 per hour) posts to #vivi-migration Slack channel via webhook (`scripts/forward_logs.py --slack`).
  - ERROR/CRITICAL automatically open GitHub issues using `scripts/create_issue_from_log.py` with log snippet + reproduction steps.
- **Traceability:** Every spec checklist item references a `spec_id`; QA can query `spec_id:"spec:tabs:indicator"` in Kibana to audit compliance.

## 9. Implementation Checklist
- [ ] All automation scripts (`component_inventory`, `migration_assistant`, etc.) call `get_logger` with `area` + `component`.
- [ ] Tamagui components emit structured entries on mount failures, focus-trap issues, and token fallbacks.
- [ ] Tests spy on logger where acceptance criteria require proofs (e.g., overflow logging) before marking specs complete.
- [ ] CI job uploads raw logs + summary to artifacts, then runs `summarize_logs.py` to append results to `docs/04-changelog.md` weekly.
- [ ] Documentation teams record notable telemetry trends in `docs/05-ideas.md` for future optimizations.
